# RssFOPMultiCloseOrder 非公式テスト確認仕様

## 概要
**関数名**: RssFOPMultiCloseOrder  
**カテゴリ**: 先物OP注文管理 (Futures & Options Order Management)  
**用途**: 先物OP複数転売買戻注文の発注  

**説明**: 指定した2件以上の建玉について、先物オプションの転売買戻注文を出します。複数入力時の上限は10件となります。複数建玉の同時決済により効率的なポジション管理が可能です。

## 構文 (Syntax)

### Excel ワークシート関数
```excel
RssFOPMultiCloseOrder(発注ID, 発注トリガー, 銘柄コード1, 売買区分1, 注文区分1, 注文数量1, 価格区分1, 注文価格1, 執行数量条件1, 執行時間条件1, 注文期限1, 建日1, 建単価1, 銘柄コード2, 売買区分2, 注文区分2, 注文数量2, 価格区分2, 注文価格2, 執行数量条件2, 執行時間条件2, 注文期限2, 建日2, 建単価2, ...)
```
※3件目以降の注文がある場合、上記の24引数に続けて、第14引数から第24引数までの11引数と同じ引数を繰り返し設定します

### VBA関数
```vb
RssFOPMultiCloseOrder_V(発注ID, 銘柄コード1, 売買区分1, 注文区分1, 注文数量1, 価格区分1, 注文価格1, 執行数量条件1, 執行時間条件1, 注文期限1, 建日1, 建単価1, 銘柄コード2, 売買区分2, 注文区分2, 注文数量2, 価格区分2, 注文価格2, 執行数量条件2, 執行時間条件2, 注文期限2, 建日2, 建単価2, ...)
```
※VBA関数は第2引数の「発注トリガー」を除いた入力形式となります
※VBA関数の上限は5件となります

## パラメータ詳細（基本24パラメータ）

| No | パラメータ名 | 必要性 | データ型 | 説明 |
|----|------------|--------|----------|------|
| 1 | 発注ID | ● | 数値 | Excelから注文を一意に識別するための番号（1以上の数値で入力。） |
| 2 | 発注トリガー | ● | 数値 | 0（False）:待機、1（True）:発注 （省略時は、「0（False）:待機」）<br>（直接True/Falseを入力可。また、数式入力も可。） |
| 3 | 銘柄コード1 | ● | 文字列 | 銘柄コード 9桁 |
| 4 | 売買区分1 | ● | 数値 | 1:売り（転売）、3:買い（買戻） |
| 5 | 注文区分1 | ● | 文字列 | 0:通常注文 |
| 6 | 注文数量1 | ● | 数値 | 注文数量を入力。 |
| 7 | 価格区分1 | △ | 文字列 | 0:成行、1:指値 |
| 8 | 注文価格1 | △ | 数値 | 注文価格を入力。成行の場合は省略。 |
| 9 | 執行数量条件1 | ● | 文字列 | 1:FOK、2:FAK、3:FAS |
| 10 | 執行時間条件1 | ● | 文字列 | 1:当セッション、4:引け、5:期間指定、9:取引最終日 |
| 11 | 注文期限1 | △ | 文字列 | 執行条件が「5:期間指定」の場合、必須。(YYYYMMDD) |
| 12 | 建日1 | ● | 文字列 | 転売買戻対象建玉の建日。(YYYYMMDD) |
| 13 | 建単価1 | ● | 数値 | 転売買戻対象建玉の建単価 |
| 14 | 銘柄コード2 | △ | 文字列 | 銘柄コード 9桁（2件目、省略可） |
| 15 | 売買区分2 | △ | 文字列 | 1:売り（転売）、3:買い（買戻）（銘柄コード2入力時は必須） |
| 16 | 注文区分2 | △ | 文字列 | 0:通常注文（銘柄コード2入力時は必須） |
| 17 | 注文数量2 | △ | 数値 | 注文数量を入力。（銘柄コード2入力時は必須） |
| 18 | 価格区分2 | △ | 文字列 | 0:成行、1:指値 |
| 19 | 注文価格2 | △ | 数値 | 注文価格を入力。成行の場合は省略。 |
| 20 | 執行数量条件2 | △ | 文字列 | 1:FOK、2:FAK、3:FAS（銘柄コード2入力時は必須） |
| 21 | 執行時間条件2 | △ | 文字列 | 1:当セッション、4:引け、5:期間指定、9:取引最終日（銘柄コード2入力時は必須） |
| 22 | 注文期限2 | △ | 文字列 | 執行条件が「5:期間指定」の場合、必須。(YYYYMMDD) |
| 23 | 建日2 | △ | 文字列 | 転売買戻対象建玉の建日。(YYYYMMDD)（銘柄コード2入力時は必須） |
| 24 | 建単価2 | △ | 数値 | 転売買戻対象建玉の建単価（銘柄コード2入力時は必須） |

**凡例**: ● 必須, △ 省略可, ▲ 条件次第で省略可, - 指定不要

**重要**: 
- 2件目以降は省略可。銘柄コード2入力時、1件目の必須項目に該当する項目は必須。
- 3件目以降の注文がある場合、上記の24引数に続けて、第14引数から第24引数までの11引数と同じ引数を繰り返し設定します
- Excel関数では最大10件、VBA関数では最大5件まで指定可能

## 使用例

### 2建玉の同時決済
```excel
=RssFOPMultiCloseOrder(1, 1, "167120019", 1, "0", 1, "1", 38600, "3", "1", , "20241201", 38500, "188120318", 3, "0", 10, "1", 140, "3", "1", , "20241201", 150)
```
日経225先物の転売とオプションの買戻を同時に実行

### 1建玉のみの決済（2件目省略）
```excel
=RssFOPMultiCloseOrder(2, 1, "167120019", 1, "0", 1, "0", , "3", "1", , "20241201", 38500, , , , , , , , , , , )
```
日経225先物の転売のみ成行で実行

### 3建玉の同時決済
```excel
=RssFOPMultiCloseOrder(3, 1, "167120019", 1, "0", 1, "1", 38600, "3", "1", , "20241201", 38500, "167120019", 1, "0", 1, "1", 38700, "3", "1", , "20241202", 38600, "167120019", 1, "0", 1, "1", 38800, "3", "1", , "20241203", 38700)
```
同一銘柄の異なる建玉を複数同時に決済

## 戻り値

### 成功時の出力
**データ型**: 文字列  
**内容**: 発注結果を表示（「上記に同じ」等）

### 失敗時の出力
**可能なエラー**:
- `#VALUE!` - パラメータ形式エラー
- `#N/A` - ログインエラー、先物OP口座未開設
- `建玉が見つかりません。` - 指定した建玉が存在しない
- `数量が不足しています。` - 決済可能数量を超えている

## エラーコード
| エラー | 原因 | 対処法 |
|--------|------|--------|
| #VALUE! | パラメータ形式エラー | パラメータの型と値を確認 |
| #N/A | ログインエラー、先物OP口座未開設 | ログイン状況、口座開設状況を確認 |
| 建玉が見つかりません | 指定した建日・建単価の建玉が存在しない | 正しい建日・建単価を指定 |
| 数量が不足 | 決済可能数量を超えている | 保有数量を確認 |

## 活用例

### 複数建玉の一括決済
```excel
// 同一銘柄の複数建玉を一括決済
=RssFOPMultiCloseOrder(1, 1, "167120019", 1, "0", 2, "0", , "3", "1", , "20241201", 38500, "167120019", 1, "0", 3, "0", , "3", "1", , "20241202", 38600)
```

### ポートフォリオの整理
```excel
// 異なる銘柄の建玉を同時に決済
=RssFOPMultiCloseOrder(2, 1, "167120019", 1, "0", 1, "1", 38600, "3", "1", , "20241201", 38500, "188120318", 3, "0", 5, "1", 140, "3", "1", , "20241201", 150)
```

### VBAでの活用（最大5件）
```vb
Sub CloseMultipleFOPPositions()
    Dim result As String
    ' VBA関数では発注トリガーを除く（最大5件）
    result = Application.WorksheetFunction.RssFOPMultiCloseOrder_V( _
        1, "167120019", 1, "0", 1, "1", 38600, "3", "1", "", _
        "20241201", 38500, "188120318", 3, "0", 10, "1", 140, _
        "3", "1", "", "20241201", 150)
    
    If result <> "#VALUE!" And result <> "#N/A" Then
        MsgBox "複数決済注文が送信されました: " & result
    Else
        MsgBox "注文エラー: " & result
    End If
End Sub
```

## 関連関数
- **RssFOPCloseOrder**: 先物OP個別決済注文
- **RssFOPMultiOpenOrder**: 先物OP複数新規注文
- **RssFOPOpenOrder**: 先物OP個別新規注文
- **RssFOPPositionList**: 先物OP建玉一覧
- **RssFOPOrderList**: 先物OP注文一覧

## 注意事項

1. **自動更新対応**: この関数は自動更新対象です（○）
2. **ログイン必要**: 楽天証券へのログインが必要です
3. **先物OP口座必要**: 先物・オプション取引口座の開設が必要です
4. **発注IDの一意性**: 発注IDは一意である必要があります
5. **VBA関数の違い**: VBA関数は第2引数の「発注トリガー」を除いた形式です
6. **建玉の特定**: 建日と建単価で建玉を一意に特定します
7. **注文件数の制限**: Excel関数は最大10件、VBA関数は最大5件まで
8. **注文区分の制限**: この関数では通常注文のみ可能（逆指値注文は不可）

## パラメータの説明

### 売買区分（決済時）
- 1:売り（転売） - 買建玉を売って決済
- 3:買い（買戻） - 売建玉を買って決済

### 建玉の特定方法
建玉を特定するには以下の情報が必要です：
- **銘柄コード**: 9桁の先物OP銘柄コード
- **建日**: 建玉を取得した日（YYYYMMDD形式）
- **建単価**: 建玉の平均取得価格

これらの情報はRssFOPPositionList関数で取得できます。

### 執行数量条件
- 1:FOK (Fill or Kill) - 全量即時約定または取消
- 2:FAK (Fill and Kill) - 一部約定後、残数量取消
- 3:FAS (Fill and Store) - 一部約定後、残数量は注文として残る

### 執行時間条件
- 1:当セッション - 当日のセッション終了まで有効
- 4:引け - 引けのみ執行
- 5:期間指定 - 指定日まで有効
- 9:取引最終日 - 限月の最終取引日まで有効

## 複数決済の利点

### リスク管理
- **一括決済**: 複数建玉を同時に決済しリスクを一度に解消
- **ポートフォリオ調整**: 複数ポジションの効率的な調整
- **損切り・利確**: 複数建玉の同時損切りまたは利確

### 執行効率
- **同時発注**: 最大10件の決済注文を一度に送信
- **操作簡便化**: 個別注文より簡単な操作
- **約定タイミング統一**: 決済タイミングのズレを最小化

## 制限事項

### 注文数制限
- Excel関数: 最大10件の同時決済
- VBA関数: 最大5件の同時決済
- 11件以上は複数回に分けて実行

### 機能制限
- 逆指値注文は非対応
- SOR注文は非対応
- 注文区分は「0:通常注文」のみ

## 拡張パラメータ（3件目以降）

3件目以降の注文を追加する場合は、以下の11パラメータを繰り返し追加：

| 追加パラメータ | データ型 | 説明 |
|---------------|----------|------|
| 銘柄コードN | 文字列 | N件目の銘柄コード |
| 売買区分N | 文字列 | N件目の売買区分 |
| 注文区分N | 文字列 | N件目の注文区分 |
| 注文数量N | 数値 | N件目の注文数量 |
| 価格区分N | 文字列 | N件目の価格区分 |
| 注文価格N | 数値 | N件目の注文価格 |
| 執行数量条件N | 文字列 | N件目の執行数量条件 |
| 執行時間条件N | 文字列 | N件目の執行時間条件 |
| 注文期限N | 文字列 | N件目の注文期限 |
| 建日N | 文字列 | N件目の建日 |
| 建単価N | 数値 | N件目の建単価 |

## バージョン情報
- RSS Version: 2.0
- 対応: Excel 2016以降
- 最終更新: 2024年

## 参考資料
- MARKETSPEED II RSS オンラインヘルプ
- 楽天証券 RSS関数マニュアル PDF