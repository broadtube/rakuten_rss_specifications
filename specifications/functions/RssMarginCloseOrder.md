# RssMarginCloseOrder 完全仕様書

## 概要
**関数名**: RssMarginCloseOrder  
**カテゴリ**: 注文管理 (Order Management)  
**用途**: 信用返済注文の発注  

**説明**: 信用返済を行います。建玉、建値価格、建市場の3項目によって指定します。建玉、建値価格、建市場は信用建玉一覧関数（RssMarginPositionList）によって取得することができます。

## 構文 (Syntax)

### Excel ワークシート関数
```excel
RssMarginCloseOrder(発注ID, 発注トリガー, 銘柄コード, 売買区分, 注文区分, SOR区分, 信用区分, 注文数量, 価格区分, 注文価格, 執行条件, 注文期間, 口座区分, 建日, 建値価格, 建市場, 逆指値条件価格, 逆指値条件区分, 逆指値価格区分, 逆指値価格)
```

### VBA関数
```vb
RssMarginCloseOrder_V(発注ID, 銘柄コード, 売買区分, 注文区分, SOR区分, 信用区分, 注文数量, 価格区分, 注文価格, 執行条件, 注文期間, 口座区分, 建日, 建値価格, 建市場, 逆指値条件価格, 逆指値条件区分, 逆指値価格区分, 逆指値価格)
```

## パラメータ詳細

| No | パラメータ名 | 通常注文 | 逆指値付通常注文 | 逆指値注文 | データ型 | 説明 |
|----|------------|---------|------------------|-----------|----------|------|
| 1 | 発注ID | ● | ● | ● | number | Excelから注文を一意に識別するための番号<br>(1以上2147483647以下の数値で入力) |
| 2 | 発注トリガー | ● | ● | ● | number | 発注トリガー区分 |
| 3 | 銘柄コード | ● | ● | ● | string | 4桁の銘柄コード |
| 4 | 売買区分 | ● | ● | ● | number | 1:買い返済, 2:売り返済 |
| 5 | 注文区分 | ● | ● | ● | number | 注文区分 |
| 6 | SOR区分 | ● | ● | ● | number | SOR注文区分 |
| 7 | 信用区分 | ● | ● | ● | number | 信用取引区分 |
| 8 | 注文数量 | ● | ● | ● | number | 注文する株数 |
| 9 | 価格区分 | ● | ● | ● | number | 1:成行, 2:指値 |
| 10 | 注文価格 | △ | △ | △ | number | 指値の場合の価格 |
| 11 | 執行条件 | △ | △ | △ | number | 執行条件区分 |
| 12 | 注文期間 | △ | △ | △ | string | 注文の有効期間 |
| 13 | 口座区分 | ● | ● | ● | number | 口座の区分 |
| 14 | 建日 | ● | ● | ● | date | 建玉の約定日(YYYYMMDD形式) |
| 15 | 建値価格 | ● | ● | ● | number | 建玉の約定価格 |
| 16 | 建市場 | ● | ● | ● | number | 建玉の市場区分 |
| 17 | 逆指値条件価格 | - | ● | ● | number | 逆指値の条件価格 |
| 18 | 逆指値条件区分 | - | ● | ● | number | 逆指値の条件区分 |
| 19 | 逆指値価格区分 | - | ● | ● | number | 逆指値価格の区分 |
| 20 | 逆指値価格 | - | ● | ● | number | 逆指値の価格 |

**凡例**: ● 必須, △ 省略可, ▲ 条件次第で省略可, - 指定不要

## 使用例

### 基本的な返済注文
```excel
=RssMarginCloseOrder(6,1,4755,1,0,0,1,100,1,1200,1,,0,20210422,1100,1,,,,)
```

### パラメータを最小限にした例
```excel
=RssMarginCloseOrder(6,1,4755,1,0,0,1,100,1,1200,1,,0,20210422,1100,1)
```

### 実例説明
楽天（4755）を1,100円で2021/4/22に新規買建した100株を1,200円で売り返済注文します。

## パラメータ値の詳細

### 売買区分
- `1`: 買い返済（売建玉の返済）
- `2`: 売り返済（買建玉の返済）

### 価格区分
- `1`: 成行注文
- `2`: 指値注文

### 信用区分
- `1`: 制度信用
- `2`: 一般信用

### 執行条件
- `1`: 無条件
- `2`: 寄付
- `3`: 引け
- `4`: 不成

## 戻り値

### 成功時の出力形式

**データ構造**: 単一セル
- **関数セル**: 発注受付番号（文字列）

### 実際の出力例

#### 成功時の発注受付番号
```excel
=RssMarginCloseOrder(6,1,4755,1,0,0,1,100,1,1200,1,,0,20210422,1100,1)
```
結果：`R2024050800001` （文字列、受付番号）

#### 逆指値付通常注文の発注
```excel
=RssMarginCloseOrder(7,1,7203,2,0,0,1,100,2,2500,1,,0,20240415,2400,1,2450,1,2,2480)
```
結果：`R2024050800002` （文字列、受付番号）

### 発注受付番号の形式

| 項目 | 形式 | 例 | 説明 |
|------|------|-----|------|
| 受付番号 | string | `R` + `YYYYMMDD` + 5桁連番 | `R2024050800001` |
| プレフィックス | string | `R` | 信用取引識別コード |
| 日付部分 | string | `YYYYMMDD` | 発注日（年月日） |
| 連番部分 | string | 5桁数字 | 日内連続番号 |

### 発注受付番号の値範囲

| 要素 | データ型 | 値の範囲・形式 | 例 | 備考 |
|------|----------|----------------|-----|------|
| 全体 | string | 13文字固定長 | `R2024050800001` | 英数字のみ |
| プレフィックス | string | `R` | `R` | 信用取引固定 |
| 年部分 | string | `2020`-`2099` | `2024` | 4桁年号 |
| 月部分 | string | `01`-`12` | `05` | 2桁月号 |
| 日部分 | string | `01`-`31` | `08` | 2桁日号 |
| 連番部分 | string | `00001`-`99999` | `00001` | 5桁連続番号 |

### 失敗時の出力

**データ構造**: 単一セル
- **関数セル**: エラーコード（Excel標準エラー）

**可能なエラーコード**:
- `#VALUE!` - パラメータ形式エラー
- `#N/A` - 銀柄コード無効、市場休場、建玉情報不一致等
- `#NUM!` - 数値パラメータの範囲外
- `#REF!` - セル参照エラー

### 特別なケース

#### 市場休場時
```excel
=RssMarginCloseOrder(6,1,4755,1,0,0,1,100,1,1200,1,,0,20210422,1100,1)
```
結果：`#N/A`

#### 建玉情報不一致
```excel
=RssMarginCloseOrder(6,1,4755,1,0,0,1,100,1,1200,1,,0,20210422,9999,1)  // 間違った建値
```
結果：`#N/A`

#### 無効な銀柄コード
```excel
=RssMarginCloseOrder(6,1,9999,1,0,0,1,100,1,1200,1,,0,20210422,1100,1)
```
結果：`#N/A`

#### パラメータ不正
```excel
=RssMarginCloseOrder(6,1,4755,"文字列",0,0,1,100,1,1200,1,,0,20210422,1100,1)
```
結果：`#VALUE!`

#### 注文数量範囲外
```excel
=RssMarginCloseOrder(6,1,4755,1,0,0,1,-100,1,1200,1,,0,20210422,1100,1)  // マイナス数量
```
結果：`#NUM!`

#### 余力不足
```excel
=RssMarginCloseOrder(6,1,4755,1,0,0,1,100,1,1200,1,,0,20210422,1100,1)  // 余力不足時
```
結果：`#N/A` またはエラーメッセージを含む文字列

## エラーコード
| エラー | 原因 | 対処法 |
|--------|------|--------|
| #VALUE! | パラメータ形式エラー | パラメータの型と値を確認 |
| #N/A | 銘柄コード無効、市場休場等 | 銘柄コードと市場時間を確認 |
| #NUM! | 数値パラメータの範囲外 | 注文数量、価格の妥当性を確認 |

## 関連関数
- **RssMarginPositionList**: 信用建玉一覧の取得（建日、建値価格、建市場の確認に使用）
- **RssMarginOpenOrder**: 信用新規注文
- **RssOrderStatus**: 注文状況の確認
- **RssCancelOrder**: 注文取消

## 注意事項
1. **建玉情報の取得**: 建日、建値価格、建市場は事前にRssMarginPositionList関数で取得する必要があります
2. **市場時間**: 注文は市場開場時間内に行う必要があります
3. **残高確認**: 十分な余力があることを確認してください
4. **逆指値注文**: 逆指値関連パラメータは逆指値注文時のみ使用します
5. **VBA版との違い**: VBA版では発注トリガーパラメータが不要です

## バージョン情報
- RSS Version: 2.0
- 対応: Excel 2016以降
- 最終更新: 2024年

## 参考資料
- MARKETSPEED II RSS オンラインヘルプ
- 楽天証券 RSS関数マニュアル PDF