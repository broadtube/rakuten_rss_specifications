# RssMarginPositionList 非公式テスト確認仕様

## 概要
**関数名**: RssMarginPositionList  
**カテゴリ**: 口座情報 (Account Information)  
**用途**: 信用建玉一覧の取得  

**説明**: 国内株式の信用建玉一覧を表示します。建玉の詳細情報（建日、建値価格、建市場等）を取得でき、信用返済注文（RssMarginCloseOrder）で必要な情報を提供します。

## 構文 (Syntax)

```excel
RssMarginPositionList(ヘッダー行, 銘柄コード, 口座区分, 信用区分, 売買, 直近最終返済日)
```

## パラメータ詳細

| No | パラメータ名 | データ型 | 必須/任意 | 説明 |
|----|------------|----------|-----------|------|
| 1 | ヘッダー行 | セル参照 | 任意 | 取得項目をセル範囲で指定。1行のみ（A1:C1形式）<br>省略時は全出力項目を表示 |
| 2 | 銘柄コード | string | 任意 | **省略**: 全て<br>**英数字4桁(or 5桁)**: 市場コードなし |
| 3 | 口座区分 | string | 任意 | **A or 省略**: 全て<br>**0**: 特定<br>**1**: 一般 |
| 4 | 信用区分 | number | 任意 | **0 or 省略**: 全て<br>**1**: 制度(6ヶ月)<br>**2**: 一般(無期限)<br>**3**: 一般(14日)<br>**4**: 一般(1日) |
| 5 | 売買 | number | 任意 | **0 or 省略**: 全て<br>**1**: 売<br>**3**: 買 |
| 6 | 直近最終返済日 | number | 任意 | **0 or 省略**: 全て<br>**1**: 当日<br>**2**: 1週間以内<br>**3**: 1ヶ月以内<br>**4**: 3ヶ月以内<br>**5**: 3ヶ月超 |

## 主要な出力項目

信用建玉一覧には以下の20項目が含まれます：

| No | 項目名 | 出力形式 | 説明 | RssMarginCloseOrderでの用途 |
|----|--------|----------|------|----------------------------|
| 1 | 銘柄コード | - | 証券コード協議会で定められた銘柄コードを表示 | ✅第3パラメータ |
| 2 | 銘柄名称 | - | 銘柄名称を表示 | - |
| 3 | 口座区分 | - | 口座区分を表示（一般、特定） | - |
| 4 | 建市場 | - | 約定した市場を表示（東証、JNX、JAX、Chi-X） | ✅第16パラメータ |
| 5 | 信用区分 | - | 信用区分を表示（制度、一般） | - |
| 6 | 弁済期限 | - | 弁済期限を表示（6ヶ月、無期限、14日、1日） | - |
| 7 | 売買 | - | 売買を表示（買建、売建） | 売買区分の判定 |
| 8 | 建玉数量 | - | 建玉数量を表示 | 返済数量の確認 |
| 9 | 発注数量 | - | 発注数量を表示 | - |
| 10 | 建値 | - | 建値を表示 | ✅第15パラメータ |
| 11 | 建日 | YYYYMMDD | 建日を表示 | ✅第14パラメータ |
| 12 | 最終返済日 | YYYYMMDD | 最終返済日を表示 | - |
| 13 | 時価 | - | 時価を表示 | - |
| 14 | 前日比 | - | 前日比を表示 | - |
| 15 | 前日比率 | - | 前日比率を表示 | - |
| 16 | 時価評価額 | - | 時価評価額を表示 | - |
| 17 | 評価損益額 | - | 評価損益額を表示 | - |
| 18 | 評価損益率 | - | 評価損益率を表示 | - |
| 19 | 保証金率 | - | 保証金率を表示 | - |
| 20 | 現金保証金率 | - | 現金保証金率を表示 | - |

## 使用例

### 基本的な使用方法
```excel
=RssMarginPositionList()
```
A1セルに入力すると、2行目から信用建玉一覧が表示されます。

### 特定銘柄の建玉取得
```excel
=RssMarginPositionList(, "4755")
```
楽天（4755）の建玉のみを表示します。

### 買建玉のみ取得
```excel
=RssMarginPositionList(,,,, 3)
```
買建玉のみを表示します。

### ヘッダー行を指定した取得
```excel
=RssMarginPositionList($A$2:$T$2)
```
2行目をヘッダーとして使用し、必要な項目のみを表示します。

## RssMarginCloseOrderとの連携

信用返済注文には以下3つの情報が必須です：

1. **建日** (第14パラメータ)
2. **建値価格** (第15パラメータ)  
3. **建市場** (第16パラメータ)

### 連携例
```excel
# 1. 建玉情報を取得
=RssMarginPositionList()

# 2. 返済注文で建玉情報を使用
=RssMarginCloseOrder(6,1,A3,1,0,0,1,100,1,1200,1,,0,H3,I3,J3)
```

上記例では、A3（銘柄コード）、H3（建日）、I3（建値価格）、J3（建市場）を建玉一覧から取得して返済注文に使用しています。

## 戻り値

### 成功時の出力形式

**データ構造**: 2次元配列（行×列）
- **1行目**: 関数式 `=RssMarginPositionList(...)`
- **2行目**: ヘッダー行（項目名）
- **3行目以降**: データ行（建玉レコード）

**出力サイズ**: 最大20列 × 動的行数

### 実際の出力例

#### 正常なデータがある場合
```
Row 1: =RssMarginPositionList()
Row 2: 銘柄コード | 銘柄名称     | 口座区分 | 建市場 | 信用区分 | 弁済期限 | 売買 | 建玉数量 | 発注数量 | 建値 | 建日     | 最終返済日 | 時価 | 前日比 | 前日比率 | 時価評価額 | 評価損益額 | 評価損益率 | 保証金率 | 現金保証金率
Row 3: 4755      | 楽天グループ | 特定     | 東証   | 制度     | 6ヶ月    | 買建 | 100      | 0        | 1100 | 20240315 | 20240915   | 1150 | 50     | 4.55     | 115000     | 5000       | 4.55       | 30       | 30
Row 4: 7203      | トヨタ自動車 | 一般     | 東証   | 一般     | 無期限   | 売建 | 200      | 0        | 2500 | 20240320 |            | 2480 | -20    | -0.80    | 496000     | 4000       | 0.81       | 30       | 30
```

#### 特定銘柄フィルター使用時
```excel
=RssMarginPositionList(, "4755")
```
```
Row 1: =RssMarginPositionList(, "4755")
Row 2: 銘柄コード | 銘柄名称     | 口座区分 | 建市場 | 信用区分 | 弁済期限 | 売買 | 建玉数量 | 発注数量 | 建値 | 建日     | 最終返済日 | 時価 | 前日比 | 前日比率 | 時価評価額 | 評価損益額 | 評価損益率 | 保証金率 | 現金保証金率
Row 3: 4755      | 楽天グループ | 特定     | 東証   | 制度     | 6ヶ月    | 買建 | 100      | 0        | 1100 | 20240315 | 20240915   | 1150 | 50     | 4.55     | 115000     | 5000       | 4.55       | 30       | 30
```

#### ヘッダー行指定時（必要な項目のみ）
```excel
=RssMarginPositionList($A$2:$D$2, "4755")
```
A2:D2セルに「銘柄コード」「売買」「建日」「建値」がある場合：
```
Row 1: =RssMarginPositionList($A$2:$D$2, "4755")
Row 2: 銘柄コード | 売買 | 建日     | 建値
Row 3: 4755      | 買建 | 20240315 | 1100
```

### 各項目の値範囲・形式詳細

| No | 項目名 | データ型 | 出力形式 | 値の範囲・パターン | 備考 |
|----|--------|----------|----------|-------------------|------|
| 1 | 銘柄コード | string | - | 4-5桁英数字<br>例：`4755`, `1234A`, `ABCD5` | 証券コード協議会規定 |
| 2 | 銘柄名称 | string | - | 全角文字列<br>例：`楽天グループ`, `トヨタ自動車` | 正式銘柄名 |
| 3 | 口座区分 | string | - | `一般` / `特定` | 口座の税制区分 |
| 4 | 建市場 | string | - | `東証` / `JNX` / `JAX` / `Chi-X` | 約定した取引所 |
| 5 | 信用区分 | string | - | `制度` / `一般` | 信用取引の種別 |
| 6 | 弁済期限 | string | - | `6ヶ月` / `無期限` / `14日` / `1日` | 返済期限の種類 |
| 7 | 売買 | string | - | `買建` / `売建` | 建玉の方向 |
| 8 | 建玉数量 | number | - | 正整数<br>例：`100`, `1000` | 株数単位 |
| 9 | 発注数量 | number | - | 0以上整数<br>例：`0`, `50` | 未約定の発注株数 |
| 10 | 建値 | number | - | 正数（価格）<br>例：`1100`, `2500.5` | 建玉時の約定価格 |
| 11 | 建日 | string | YYYYMMDD | 日付形式<br>例：`20240315` | 建玉約定日 |
| 12 | 最終返済日 | string | YYYYMMDD | 日付形式または空<br>例：`20240915`, `` | 期限がある場合のみ |
| 13 | 時価 | number | - | 正数（価格）<br>例：`1150`, `2480` | 現在の株価 |
| 14 | 前日比 | number | - | 実数（±）<br>例：`+50`, `-20` | 前日終値からの差額 |
| 15 | 前日比率 | number | - | 実数（%）<br>例：`4.55`, `-0.80` | パーセント値（%記号なし） |
| 16 | 時価評価額 | number | - | 実数<br>例：`115000`, `496000` | 時価 × 数量 |
| 17 | 評価損益額 | number | - | 実数（±）<br>例：`+5000`, `+4000` | 含み損益 |
| 18 | 評価損益率 | number | - | 実数（%）<br>例：`4.55`, `0.81` | 含み損益率（%記号なし） |
| 19 | 保証金率 | number | - | 実数（%）<br>例：`30`, `50` | 必要保証金率（%記号なし） |
| 20 | 現金保証金率 | number | - | 実数（%）<br>例：`30`, `50` | 現金保証金率（%記号なし） |

### データ型と形式の補足

**数値項目の精度**:
- 価格項目（建値、時価）: 小数点以下は銘柄の値段単位に依存
- 比率項目: 小数点以下2桁程度
- 金額項目: 整数（円単位）

**日付項目の形式**:
- YYYYMMDD固定（8桁）
- 該当なしの場合は空文字列

**文字列項目の文字エンコーディング**:
- 日本語はUTF-8またはShift_JIS
- 半角英数字は市場コード等で使用

### 失敗時の出力

**データ構造**: 単一セル
- **関数セル**: エラーコード（Excel標準エラー）

**可能なエラーコード**:
- `#VALUE!` - パラメータ形式エラー
- `#N/A` - データなし、接続エラー  
- `#REF!` - セル参照エラー
- `#NUM!` - 数値範囲エラー

### 特別なケース

#### データなし時の動作
建玉が存在しない場合：
```
Row 1: =RssMarginPositionList()
Row 2: 銘柄コード | 銘柄名称 | 口座区分 | 建市場 | 信用区分 | 弁済期限 | 売買 | 建玉数量 | 発注数量 | 建値 | 建日 | 最終返済日 | 時価 | 前日比 | 前日比率 | 時価評価額 | 評価損益額 | 評価損益率 | 保証金率 | 現金保証金率
```
※ヘッダー行のみが表示され、データ行（3行目以降）は出力されません

#### 無効なフィルター条件時
存在しない銘柄コードを指定した場合：
```excel
=RssMarginPositionList(, "9999")  // 存在しない銘柄
```
```
Row 1: =RssMarginPositionList(, "9999")
Row 2: 銘柄コード | 銘柄名称 | 口座区分 | ... （ヘッダー行のみ）
```

#### ヘッダー行の範囲指定エラー時
```excel
=RssMarginPositionList($A$2:$A$5)  // 複数行指定（エラー）
```
結果：`#REF!`

#### RSS接続断時
```excel
=RssMarginPositionList()
```
結果：`#N/A`（全セルがエラーになる）

## エラーコード詳細
| エラー | 原因 | 対処法 |
|--------|------|--------|
| #VALUE! | パラメータ形式エラー | パラメータの型と値を確認 |
| #N/A | データなし、接続エラー | RSS接続とデータの存在を確認 |
| #REF! | セル参照エラー | ヘッダー行の指定を確認 |

## 関連関数
- **RssMarginCloseOrder**: 信用返済注文（建玉情報が必要）
- **RssMarginOpenOrder**: 信用新規注文
- **RssPositionList**: 現物建玉一覧
- **RssFOPPositionList**: 先物OP建玉一覧

## 注意事項

1. **データの更新**: 建玉情報はリアルタイムで更新されます
2. **ヘッダー行の重要性**: ヘッダー行を指定することで必要な項目のみを効率的に取得できます
3. **返済注文での利用**: 建日、建値価格、建市場は返済注文で必須の情報です
4. **フィルター機能**: パラメータを組み合わせることで特定条件の建玉のみを表示できます
5. **表示形式**: A1に関数を入力すると2行目がヘッダー、3行目以降がデータとして表示されます

## 出力データの形式

関数実行後、以下の形式でデータが表示されます：

```
Row 1: =RssMarginPositionList() (関数)
Row 2: [ヘッダー行] 銘柄コード | 銘柄名 | 市場 | ... | 建日 | 建値 | 建市場
Row 3: [データ1]   4755      | 楽天  | 東証 | ... | 20210422 | 1100 | 1
Row 4: [データ2]   7203      | トヨタ | 東証 | ... | 20210420 | 8500 | 1
...
```

## バージョン情報
- RSS Version: 2.0
- 対応: Excel 2016以降
- 最終更新: 2024年

## 参考資料
- MARKETSPEED II RSS オンラインヘルプ
- MARKETSPEED II オンラインヘルプ「注文照会 信用建玉一覧」