# RssFOPCloseOrder 非公式テスト確認仕様

## 概要
**関数名**: RssFOPCloseOrder  
**カテゴリ**: 先物OP注文管理 (Futures & Options Order Management)  
**用途**: 先物OP転売買戻注文の発注  

**説明**: 指定した先物オプション取引建玉について、注文区分ごとに転売買戻注文を出します。保有している建玉を指定して決済注文を発注できます。

## 構文 (Syntax)

### Excel ワークシート関数
```excel
RssFOPCloseOrder(発注ID, 発注トリガー, 銘柄コード, 売買区分, 注文区分, 注文数量, 価格区分, 注文価格, 執行数量条件, 執行時間条件, 注文期限, 建日, 建単価, 逆指値条件価格, 逆指値条件区分, 逆指値価格区分, 逆指値価格, SOR区分)
```

### VBA関数
```vb
RssFOPCloseOrder_V(発注ID, 銘柄コード, 売買区分, 注文区分, 注文数量, 価格区分, 注文価格, 執行数量条件, 執行時間条件, 注文期限, 建日, 建単価, 逆指値条件価格, 逆指値条件区分, 逆指値価格区分, 逆指値価格, SOR区分)
```
※VBA関数は第2引数の「発注トリガー」を除いた入力形式となります

## パラメータ詳細

| No | パラメータ名 | 必要性 | データ型 | 説明 |
|----|------------|--------|----------|------|
| 1 | 発注ID | ● | 数値 | Excelから注文を一意に識別するための番号（1以上の数値で入力。） |
| 2 | 発注トリガー | ● | 数値 | 0（False）:待機、1（True）:発注 （省略時は、「0（False）:待機」）<br>（直接True/Falseを入力可。また、数式入力も可。） |
| 3 | 銘柄コード | ● | 文字列 | 銘柄コード 9桁 |
| 4 | 売買区分 | ● | 文字列 | 1:売り（転売）、3:買い（買戻） |
| 5 | 注文区分 | ● | 文字列 | 0:通常注文、1:逆指値付通常注文、2:逆指値注文 |
| 6 | 注文数量 | ● | 数値 | 注文数量を入力。 |
| 7 | 価格区分 | △ | 文字列 | 0:成行、1:指値<br>（注文区分が「0:通常注文」 or 「1:逆指値付通常注文」 の場合、必須。） |
| 8 | 注文価格 | △ | 数値 | 注文価格を入力。成行の場合は省略。<br>（注文区分が「0:通常注文」 or 「1:逆指値付通常注文」 の場合、必須。） |
| 9 | 執行数量条件 | ● | 文字列 | 1:FOK、2:FAK、3:FAS |
| 10 | 執行時間条件 | ● | 文字列 | 1:本日中、2:今週中、3:寄付、4:引け、5:期間指定、6:大引不成、7:不成 |
| 11 | 注文期限 | △ | 文字列 | 執行時間条件が「5:期間指定」の場合、必須。(YYYYMMDD) |
| 12 | 建日 | ● | 文字列 | 建玉を特定するための建日（YYYYMMDD形式） |
| 13 | 建単価 | ● | 数値 | 建玉を特定するための建単価 |
| 14 | 逆指値条件価格 | △ | 数値 | 逆指値条件価格を入力。<br>（注文区分が「1:逆指値付通常注文」 or 「2:逆指値注文」の場合、必須。） |
| 15 | 逆指値条件区分 | △ | 文字列 | 1:以上、2:以下<br>（注文区分が「1:逆指値付通常注文」 or 「2:逆指値注文」の場合、必須。） |
| 16 | 逆指値価格区分 | △ | 文字列 | 0:成行、1:指値<br>（注文区分が「1:逆指値付通常注文」 or 「2:逆指値注文」の場合、必須。） |
| 17 | 逆指値価格 | △ | 数値 | 逆指値価格を入力。成行の場合は省略。<br>（注文区分が「1:逆指値付通常注文」 or 「2:逆指値注文」の場合、必須。） |
| 18 | SOR区分 | △ | 文字列 | 0:通常注文、1:SOR注文（省略時は、「0:通常注文」） |

**凡例**: ● 必須, △ 省略可, ▲ 条件次第で省略可, - 指定不要

## 使用例

### 先物建玉の決済注文（転売）
```excel
=RssFOPCloseOrder(1, 1, "167120019", "1", "0", 1, "1", 38600, "3", "1", , "20241201", 38500, , , , , "0")
```

### オプション建玉の決済注文（買戻）
```excel
=RssFOPCloseOrder(2, 1, "188120318", "3", "0", 5, "1", 140, "3", "1", , "20241201", 150, , , , , "0")
```

### 逆指値での決済注文
```excel
=RssFOPCloseOrder(3, 1, "167120019", "1", "2", 1, , , "3", "1", , "20241201", 38500, 38000, "2", "0", , "0")
```

## 戻り値

### 成功時の出力
**データ型**: 文字列  
**内容**: 発注結果を表示（「上記に同じ」等）

### 失敗時の出力
**可能なエラー**:
- `#VALUE!` - パラメータ形式エラー
- `#N/A` - ログインエラー、先物OP口座未開設
- `建玉が見つかりません。` - 指定した建玉が存在しない
- `数量が不足しています。` - 決済可能数量を超えている

## エラーコード
| エラー | 原因 | 対処法 |
|--------|------|--------|
| #VALUE! | パラメータ形式エラー | パラメータの型と値を確認 |
| #N/A | ログインエラー、先物OP口座未開設 | ログイン状況、口座開設状況を確認 |
| 建玉が見つかりません | 指定した建日・建単価の建玉が存在しない | 正しい建日・建単価を指定 |
| 数量が不足 | 決済可能数量を超えている | 保有数量を確認 |

## 活用例

### 建玉一覧と連携した決済
```excel
// RssFOPPositionListで建玉情報を取得
A1: =RssFOPPositionList()
// 取得した建玉情報を使って決済注文
=RssFOPCloseOrder(1, 1, A2, IF(D2="買","1","3"), "0", E2, "0", , "3", "1", , I2, E2, , , , , "0")
```

### VBAでの活用
```vb
Sub CloseFOPPosition()
    Dim result As String
    ' VBA関数では発注トリガーを除く
    result = Application.WorksheetFunction.RssFOPCloseOrder_V( _
        1, "167120019", "1", "0", 1, "1", 38600, "3", "1", "", _
        "20241201", 38500, "", "", "", "", "0")
    
    If result <> "#VALUE!" And result <> "#N/A" Then
        MsgBox "決済注文が送信されました: " & result
    Else
        MsgBox "注文エラー: " & result
    End If
End Sub
```

## 関連関数
- **RssFOPOpenOrder**: 先物OP新規注文
- **RssFOPPositionList**: 先物OP建玉一覧
- **RssFOPModifyOrder**: 先物OP注文訂正
- **RssFOPCancelOrder**: 先物OP注文取消
- **RssFOPMultiCloseOrder**: 先物OP複数転売買戻注文

## 注意事項

1. **自動更新対応**: この関数は自動更新対象です（○）
2. **ログイン必要**: 楽天証券へのログインが必要です
3. **先物OP口座必要**: 先物・オプション取引口座の開設が必要です
4. **建玉の特定**: 建日と建単価で建玉を一意に特定します
5. **VBA関数の違い**: VBA関数は第2引数の「発注トリガー」を除いた形式です
6. **売買区分の注意**: 転売（売り）は買建玉の決済、買戻（買い）は売建玉の決済です
7. **部分決済**: 建玉の一部だけを決済することも可能です

## パラメータの説明

### 売買区分（決済時）
- 1:売り（転売） - 買建玉を売って決済
- 3:買い（買戻） - 売建玉を買って決済

### 建玉の特定方法
建玉を特定するには以下の情報が必要です：
- **銘柄コード**: 9桁の先物OP銘柄コード
- **建日**: 建玉を取得した日（YYYYMMDD形式）
- **建単価**: 建玉の平均取得価格

これらの情報はRssFOPPositionList関数で取得できます。

## バージョン情報
- RSS Version: 2.0
- 対応: Excel 2016以降
- 最終更新: 2024年

## 参考資料
- MARKETSPEED II RSS オンラインヘルプ
- 楽天証券 RSS関数マニュアル PDF